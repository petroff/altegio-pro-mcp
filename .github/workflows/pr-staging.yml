name: PR Staging Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  # Quality gates MUST pass before deploy
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run typecheck

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

  # Deploy to staging ONLY if quality checks pass
  deploy-staging:
    needs: quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: github-actions@altegio-mcp.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Trigger Cloud Build
        id: build
        run: |
          # Sanitize branch name for service naming
          BRANCH_NAME="${{ github.head_ref }}"
          SANITIZED=$(echo "$BRANCH_NAME" | \
            sed 's/[^a-zA-Z0-9-]/-/g' | \
            tr '[:upper:]' '[:lower:]' | \
            cut -c1-40)

          echo "sanitized=$SANITIZED" >> $GITHUB_OUTPUT

          # Submit build
          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild-staging.yaml \
            --substitutions=_REGION=europe-west1,_ARTIFACT_REPO=cloud-run-source-deploy,_SECRET_NAME=altegio-api-token,BRANCH_NAME=$BRANCH_NAME,SHORT_SHA=${{ github.sha }} \
            --format="value(id)")

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

          # Wait for build to complete
          gcloud builds log $BUILD_ID --stream

      - name: Get service URL
        id: service
        run: |
          SERVICE_NAME="altegio-mcp-${{ steps.build.outputs.sanitized }}"
          SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
            --region=europe-west1 \
            --format='value(status.url)')

          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: Comment PR with staging URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.service.outputs.url }}';
            const body = `## ðŸš€ Staging Deployment

            âœ… Quality checks passed
            âœ… Deployed to staging environment

            **Service URL:** ${url}
            **Health check:** ${url}/health
            **Branch:** \`${{ github.head_ref }}\`
            **Commit:** \`${{ github.sha }}\`

            Auto-cleanup: 3 days after last deployment`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
